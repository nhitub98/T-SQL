-- 1. Sử dụng lệnh để tạo CSDL có tên QLHH:
create database QLHH
ON
( NAME = QLHH_DATA,
    FILENAME = 'C:\Devmaster.edu.vn\DEV2311LM-SQL24\DATA\QLHH.mdf',
    SIZE = 50MB,
    MAXSIZE = 200MB,
    FILEGROWTH = 10MB 
)
LOG ON
( NAME = QLHH_log,
    FILENAME = 'C:\Devmaster.edu.vn\DEV2311LM-SQL24\DATA\QLHH_log.ldf',
    SIZE = 10MB,
    MAXSIZE = unlimited,
    FILEGROWTH = 5MB 
	);
GO
--2. Tạo csdl QLBH

create database QLBH
GO
use QLBH
---- Tạo bảng VATTU
CREATE TABLE VATTU
(
	MaVTu char(4) not null,
	TenVTu nvarchar(100),
	DvTinh nvarchar(10),
	PhanTram real,
	Primary Key (MaVTu)
)
Go
-- CONSTRAINT VATTU
ALTER TABLE VATTU
	ADD
	CONSTRAINT UQ_VATTU_TenVTu UNIQUE(TenVTu),
	CONSTRAINT DF_VATTU_Dvtinh DEFAULT '' For DvTinh,
	CONSTRAINT CK_VATTU_PhanTram CHECK(PhanTram between 0 And 100)
Go

-- Tạo Bảng NHACC
CREATE TABLE NHACC
(
	MaNhaCc char(3) not null,
	TenNhaCc varchar(100),
	DiaChi varchar(200),
	DienThoai nvarchar(20),
	Primary Key (MaNhaCc)
)
GO
--CONSTRAINT NCC
ALTER TABLE NHACC
	ADD
	CONSTRAINT UQ_NHACC_TenNhaCc UNIQUE(TenNhaCc,DiaChi),	
	CONSTRAINT DF_NHACC_DienThoai DEFAULT 'Chua co' For dienthoai
	GO
--Tạo bảng DONDH
CREATE TABLE DONDH
(
	SoDh char(4) not null,
	NgayDh datetime,
	MaNhaCc char(3) not null,	
	Primary Key (SoDh)
)
GO
--Foreign Key (MaNCC) References NhaCC(ManCC) 

--CONSTRAINT DONDH
ALTER TABLE DONDH
	ADD	
	CONSTRAINT FK_DONDH_MaNhaCc FOREIGN KEY(MaNhaCc) REFERENCES Nhacc(MaNhaCc),
	CONSTRAINT DF_DONDH_NgayDh DEFAULT Getdate() For NgayDh
Go
--Tạo bảng CTDONDH
CREATE TABLE CTDONDH
(
	SoDh char(4) not null,
	MaVTu char(4) not null,
	SlDat int not null,	
	Primary key (SoDh,MaVTu)
	--Foreign Key (SoDH) References DonDH(SoDH),
	--Foreign Key (MaVTu) References Vattu(MaVTu)
)
GO
--CONSTRAINT CTDONDH
ALTER TABLE CTDONDH
	ADD	
	CONSTRAINT FK_CTDONDH_SoDh FOREIGN KEY(SoDh) REFERENCES DONDH(SoDh),
	CONSTRAINT FK_CTDONDH_MaVTu FOREIGN KEY(MaVTu) REFERENCES Vattu(MaVTu),	
	CONSTRAINT CK_CTDONDH_SlDat CHECK(SlDat>0)
Go
--Tạo bảng PNHAP
CREATE TABLE PNHAP
(
	SoPn char(4) not null,
	NgayNhap Datetime CONSTRAINT DF_PNHAP_NgayNhap DEFAULT GETDATE(),
	SoDh char(4) not null,	
	Primary key (SoPn)
	--Foreign Key (SoDH) References ĐONH(SoDh)	
)
GO
--Tạo bảng CTPNHAP
CREATE TABLE CTPNHAP
(
	SoPn char(4) not null,
	MaVTu char(4) not null,
	SlNhap Int not null,	
	DgNhap Money not null,
	primary key (SoPn,MaVTu)
	--Foreign Key (SoPn) References PNHAP(SoPn),
	--Foreign Key (MaVTu) References VATTU(MaVTu)	
)
GO
--CONSTRAINT CTPNHAP
ALTER TABLE CTPNHAP
	ADD	
	CONSTRAINT FK_CTPNHAP_SoPn FOREIGN KEY(SoPn) REFERENCES PNHAP(SoPn),
	CONSTRAINT FK_CTPNHAP_MaVTu FOREIGN KEY(MaVTu) REFERENCES VATTU(MaVTu),
	CONSTRAINT CK_CTPNHAP_SlNhap CHECK(SlNhap>0),
	CONSTRAINT CK_CTPNHAP_DgNhap CHECK(DgNhap>0)
Go

--Tạo bảng PXUAT
CREATE TABLE PXUAT
(
	SoPx char(4) not null,
	NgayXuat Datetime CONSTRAINT DF_PXUAT_NgayXuat DEFAULT GETDATE(),
	TenKh Varchar(100) not null,	
	Primary key (SoPx)	
)
GO
--Tạo bảng CTPXUAT
CREATE TABLE CTPXUAT
(
	SoPx char(4) not null,
	MaVTu char(4) not null,
	SLXuat Int,	
	DGXuat Money,
	Primary key (SoPx,MaVTu)	
)
GO
--CONSTRAINT CTPXUAT
ALTER TABLE CTPXUAT
	ADD	
	CONSTRAINT FK_CTPXUAT_SoPx FOREIGN KEY(SoPx) REFERENCES PXUAT(SoPx),
	CONSTRAINT FK_CTPXUAT_MaVTu FOREIGN KEY(MaVTu) REFERENCES Vattu(MaVTu),			
	CONSTRAINT CK_CTPXUAT_SLXuat CHECK(SlXuat>0),
	CONSTRAINT CK_CTPXUAT_DgXuat CHECK(DgXuat>0)
Go
---Tạo bảng TONKHO


CREATE TABLE TONKHO
(
	NamThang char(6) not null,
	MaVTu char(4) not null,
	SLDau Int not null,	
	TongSLN int not null,
	TongSLX int not null,
	SLCuoi as (SLDau+TongSLN-TongSLX),
	Primary key (NamThang,MaVTu)		
)
GO
--CONSTRAINT TONKHO
ALTER TABLE TONKHO
	ADD	
	CONSTRAINT FK_TONKHO_MaVTu FOREIGN KEY(MaVTu) REFERENCES Vattu(MaVTu),				
	CONSTRAINT CK_CTPXUAT_SlDau CHECK(SlDau>0),
	CONSTRAINT CK_TONKHO_TongSLN CHECK(TongSLN>0),
	CONSTRAINT CK_TONKHO_TongSLX CHECK(TongSLX>0),
	CONSTRAINT DF_CTPXUAT_SlDau DEFAULT 0 For SlDau,
	CONSTRAINT DF_TONKHO_TongSLN DEFAULT 0 For TongSLN,
	CONSTRAINT DF_TONKHO_TongSLX DEFAULT 0 For TongSLX
Go
4. 
--Thêm dữ liệu vào bảng NHACC
INSERT INTO NHACC VALUES ('C01',N'Lê Minh Thành',N'54, Kim Mã, Cầu Giấy, Hà Nội','8781024')
INSERT INTO NHACC VALUES ('C02',N'Trần Quang Anh',N'145, Hùng Vương, Hải Dương','7698154')
INSERT INTO NHACC VALUES ('C03',N'Bùi Hồng Phương',N'154/85, Lê Chân, Hải Phòng','9600125')
INSERT INTO NHACC VALUES ('C04',N'Vũ Nhật Thắng',N'198/40 H­ương Lộ 14 QTB HCM','8757757')
INSERT INTO NHACC VALUES ('C05',N'Nguyễn Thị Thuý',N'178 Nguyễn Văn Luông Đà Lạt','7964251')
INSERT INTO NHACC VALUES ('C07','Cao Minh Trung',N'125 Lê Quang Sung Nha Trang','')
Go
--Thêm dữ liệu vào bảng VATTU
INSERT INTO VATTU VALUES ('DD01',N'Đầu DVD Hitachi 1 đĩa',N'Bộ',40)
INSERT INTO VATTU VALUES ('DD02',N'Đầu DVD Hitachi 3 đĩa',N'Bộ',40)
INSERT INTO VATTU VALUES ('TL15',N'Tủ lạnh Sanyo 150 lít',N'Cái',25)
INSERT INTO VATTU VALUES ('TL90',N'Tủ Lạnh Sanyo 90 lít',N'Cái',20)
INSERT INTO VATTU VALUES ('TV14',N'Tivi SONY 14 inches',N'Cái',15)
INSERT INTO VATTU VALUES ('TV21',N'Tivi SONY 21 inches',N'Cái',10)
INSERT INTO VATTU VALUES ('TV29',N'Tivi SONY 29 inches',N'Cái',10)
INSERT INTO VATTU VALUES ('VD01',N'Đầu VCD SONY 1 đĩa',N'Bộ',30)
INSERT INTO VATTU VALUES ('VD02',N'Đầu VCD SONY 3 đĩa',N'Bộ',30)
Go
--Thêm dữ liệu vào bảng DONDH
INSERT INTO DONDH VALUES('D001','01/15/2012','C03')
INSERT INTO DONDH VALUES('D002','01/30/2012','C01')
INSERT INTO DONDH VALUES('D003','02/10/2012','C02')
INSERT INTO DONDH VALUES('D004','02/17/2012','C05')
INSERT INTO DONDH VALUES('D005','03/01/2012','C02')
INSERT INTO DONDH VALUES('D006','03/12/2012','C05')
Go
--Thêm dữ liệu vào bảng PNHAP
INSERT INTO PNHAP VALUES('N001','01/17/2012','D001')
INSERT INTO PNHAP VALUES('N002','01/20/2012','D001')
INSERT INTO PNHAP VALUES('N003','01/31/2012','D002')
Go
--Thêm dữ liệu vào bảng CTDONDH
INSERT INTO CTDONDH VALUES('D001','DD01',10)
INSERT INTO CTDONDH VALUES('D001','DD02',15)
INSERT INTO CTDONDH VALUES('D002','VD02',30)
INSERT INTO CTDONDH VALUES('D003','TV14',10)
INSERT INTO CTDONDH VALUES('D003','TV29',20)
INSERT INTO CTDONDH VALUES('D004','TL90',10)
INSERT INTO CTDONDH VALUES('D005','TV14',10)
INSERT INTO CTDONDH VALUES('D005','TV29',20)
INSERT INTO CTDONDH VALUES('D006','TV14',10)
INSERT INTO CTDONDH VALUES('D006','TV29',20)
INSERT INTO CTDONDH VALUES('D006','VD01',20)
Go
--Thêm dữ liệu vào bảng CTPNHAP
INSERT INTO CTPNHAP VALUES('N001','DD01',8 ,25)
INSERT INTO CTPNHAP VALUES('N001','DD02',10 ,35)
INSERT INTO CTPNHAP VALUES('N002','DD01', 2,25)
INSERT INTO CTPNHAP VALUES('N002','DD02', 5,35)
INSERT INTO CTPNHAP VALUES('N003','VD02', 30,25)
INSERT INTO CTPNHAP VALUES('N004','TV14', 5,25)
INSERT INTO CTPNHAP VALUES('N004','TV21', 12,35)
UPDATE  CTPNHAP SET DgNhap=DgNhap*100000
Go
--Thêm dữ liệu vào bảng PXUAT
INSERT INTO PXUAT VALUES('X001','01/17/2012','Nguyen Ngoc Phuong Nhi')
INSERT INTO PXUAT VALUES('X002','01/25/2012','Nguyen Hong Phuong')
INSERT INTO PXUAT VALUES('X003','01/31/2012','Nguyen Tuan Tu')
Go
--Thêm dữ liệu vào bảng CTPXUAT
INSERT INTO CTPXUAT VALUES('X001','DD01',2 ,35)
INSERT INTO CTPXUAT VALUES('X002','DD01',1 ,35)
INSERT INTO CTPXUAT VALUES('X002','DD02', 5,49)
INSERT INTO CTPXUAT VALUES('X003','DD01', 3,35)
INSERT INTO CTPXUAT VALUES('X003','DD02', 2,49)
INSERT INTO CTPXUAT VALUES('X003','VD02', 10,32.5)

UPDATE  CTPXUAT SET DGXuat=DGXuat*100000
Go
--Thêm dữ liệu vào bảng TONKHO

INSERT INTO TONKHO(NamThang,MaVTu,SLDau,TongSLN,TongSLX) VALUES('201201','DD01',0,10,6 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201201','DD02',0,15,7 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201201','VD02',0,30,10 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201202','DD01',4,0,0 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201202','DD02',8,0,0 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201202','VD02',20,0,0 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201202','TV14',5,0,0 )
INSERT INTO TONKHO(Namthang,Mavtu,SLDau,TongSLN,TongSLX) VALUES('201202','TV29',12,0,0 )
GO
select * from pnhap